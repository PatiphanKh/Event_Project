<?php
// à¸šà¸±à¸‡à¸„à¸±à¸šà¸¥à¹‡à¸­à¸à¸­à¸´à¸™
if (!isset($_SESSION['uid'])) {
    header('Location: /login');
    exit;
}

$error = '';
$success = '';
$uid = $_SESSION['uid'];

$eid = $_GET['id'] ?? $_POST['id'] ?? 0;
$event = getEventById($eid);

// à¹€à¸Šà¹‡à¸à¸§à¹ˆà¸²à¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹à¸à¹‰à¹„à¸‚à¹„à¸«à¸¡
if (!$event || $event['creator_uid'] != $uid) {
    header('Location: /my-events');
    exit;
}

// ==========================================
// à¸ªà¹ˆà¸§à¸™à¸ˆà¸±à¸”à¸à¸²à¸£: à¸¥à¸šà¸£à¸¹à¸›à¸ à¸²à¸ž (à¸–à¹‰à¸²à¸¡à¸µà¸à¸²à¸£à¸à¸”à¸›à¸¸à¹ˆà¸¡à¸¥à¸šà¸£à¸¹à¸›)
// ==========================================
if (isset($_GET['delete_img'])) {
    $imgid = $_GET['delete_img'];
    if (deleteEventImage($imgid, $eid)) {
        // à¸¥à¸šà¹€à¸ªà¸£à¹‡à¸ˆà¹ƒà¸«à¹‰à¸£à¸µà¹€à¸Ÿà¸£à¸Šà¸«à¸™à¹‰à¸²à¸•à¸±à¸§à¹€à¸­à¸‡ 1 à¸£à¸­à¸š à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸£à¸¹à¸›à¸«à¸²à¸¢à¹„à¸›
        header("Location: /event-edit?id=" . $eid . "&msg=deleted");
        exit;
    }
}

// à¸£à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸–à¹‰à¸²à¸¥à¸šà¸£à¸¹à¸›à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
if (isset($_GET['msg']) && $_GET['msg'] === 'deleted') {
    $success = 'à¸¥à¸šà¸£à¸¹à¸›à¸ à¸²à¸žà¸ªà¸³à¹€à¸£à¹‡à¸ˆ!';
}

// ==========================================
// à¸ªà¹ˆà¸§à¸™à¸ˆà¸±à¸”à¸à¸²à¸£: à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¹€à¸žà¸´à¹ˆà¸¡
// ==========================================
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $name = $_POST['name'] ?? '';
    $description = $_POST['description'] ?? '';
    $quantity = $_POST['quantity'] ?? 0;
    $start_date = $_POST['start_date'] ?? '';
    $end_date = $_POST['end_date'] ?? '';

    // à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
    if (updateEvent($eid, $uid, $name, $description, $quantity, $start_date, $end_date)) {
        
        // à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸ à¸²à¸ž (à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸‚à¹‰à¸²à¹„à¸›à¹ƒà¸«à¸¡à¹ˆ)
        // à¹ƒà¸Šà¹‰ __DIR__ . '/../' à¹€à¸žà¸·à¹ˆà¸­à¸–à¸­à¸¢à¸«à¸¥à¸±à¸‡à¸­à¸­à¸à¸¡à¸² 1 à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ à¹ƒà¸«à¹‰à¸­à¸¢à¸¹à¹ˆà¸«à¸™à¹‰à¸²à¸ªà¸¸à¸”à¸‚à¸­à¸‡à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œ
        $uploadDir = __DIR__ . '/../uploads/'; 
        
        if (!is_dir($uploadDir)) {
            mkdir($uploadDir, 0777, true);
        }

        if (isset($_FILES['images']) && !empty($_FILES['images']['name'][0])) {
            $fileCount = count($_FILES['images']['name']);
            for ($i = 0; $i < $fileCount; $i++) {
                $tmpName = $_FILES['images']['tmp_name'][$i];
                $fileName = time() . '_' . basename($_FILES['images']['name'][$i]);
                
                // à¸žà¸²à¸˜à¸ªà¸³à¸«à¸£à¸±à¸šà¸¢à¹‰à¸²à¸¢à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ Server (Mac à¸‚à¸­à¸‡à¸„à¸¸à¸“)
                $targetFilePath = $uploadDir . $fileName; 
                
                // à¸žà¸²à¸˜à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸‹à¸Ÿà¸¥à¸‡ Database (à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸šà¸”à¸¶à¸‡à¹„à¸›à¹‚à¸Šà¸§à¹Œà¹„à¸”à¹‰à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡)
                $dbFilePath = '/uploads/' . $fileName; 

                if (move_uploaded_file($tmpName, $targetFilePath)) {
                    addEventImage($eid, $dbFilePath); // à¹€à¸‹à¸Ÿà¸¥à¸‡ DB
                }
            }
        }

        $success = 'à¸­à¸±à¸›à¹€à¸”à¸•à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¹à¸¥à¸°à¸£à¸¹à¸›à¸ à¸²à¸žà¸ªà¸³à¹€à¸£à¹‡à¸ˆ! ðŸŽ‰';
        $event = getEventById($eid); // à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¸¡à¹ˆà¸¡à¸²à¹‚à¸Šà¸§à¹Œ
    } else {
        $error = 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸­à¸±à¸›à¹€à¸”à¸• à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ';
    }
}

// à¸”à¸¶à¸‡à¸£à¸¹à¸›à¸ à¸²à¸žà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸‚à¸­à¸‡à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸™à¸µà¹‰à¸¡à¸²à¹à¸ªà¸”à¸‡
$eventImages = getEventImages($eid);

// à¹‚à¸«à¸¥à¸”à¸«à¸™à¹‰à¸²à¸ˆà¸­ UI à¹à¸¥à¸°à¸ªà¹ˆà¸‡à¸•à¸±à¸§à¹à¸›à¸£ $eventImages à¹„à¸›à¸”à¹‰à¸§à¸¢
renderView('event-edit', [
    'event' => $event,
    'eventImages' => $eventImages,
    'error' => $error,
    'success' => $success
]);